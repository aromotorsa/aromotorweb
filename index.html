<!DOCTYPE html>
<html lang="es" class="bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#EF4444"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        #loading-spinner { border-top-color: #EF4444; }
        .notification { transition: all 0.3s ease-in-out; }
        .modal-overlay { display: none; }
        .modal-overlay.flex { display: flex; }
    </style>
</head>
<body class="antialiased font-sans">

    <div id="app" class="container mx-auto p-4">

        <header class="bg-white rounded-lg shadow-md p-4 mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="flex items-center min-w-0">
                <img src="logos/AROMOTOR.png" alt="Logo Empresa" class="h-10 mr-3 flex-shrink-0">
            </div>
            <div class="flex items-center gap-2 sm:gap-4 flex-wrap justify-center">
                <button id="download-catalog-button" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2" title="Descargar catálogo para uso offline">
                    <i class="fas fa-cloud-download-alt"></i>
                    <span class="hidden sm:inline">Offline</span>
                </button>
                <button id="download-pdf-button" class="bg-red-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-800 transition-colors flex items-center gap-2" title="Descargar como catálogo visual (PDF)">
                    <i class="fas fa-file-pdf"></i>
                    <span class="hidden sm:inline">PDF</span>
                </button>
                <button id="saved-orders-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                    <i class="fas fa-save"></i>
                    <span class="hidden sm:inline">Pedidos</span>
                </button>
            </div>
        </header>
        
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <input type="search" id="search-box" placeholder="Buscar por nombre, referencia..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition sm:col-span-2 lg:col-span-4">
                <select id="category-filter" class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-red-500 focus:border-transparent transition">
                    <option value="">Todas las Categorías</option>
                </select>
                <select id="subcategory-filter" class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-red-500 focus:border-transparent transition">
                    <option value="">Todas las Subcategorías</option>
                </select>
                <select id="brand-filter" class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-red-500 focus:border-transparent transition">
                    <option value="">Todas las Marcas</option>
                </select>
            </div>
             <div class="flex justify-between items-center mt-4">
                <div>
                    <p id="results-count" class="text-gray-600 text-sm"></p>
                    <button id="clear-filters" class="text-sm text-red-600 hover:text-red-800 font-semibold">Limpiar Filtros</button>
                </div>
                <div id="view-toggle" class="text-xl flex gap-3">
                    <button data-view="grid" class="view-btn text-red-600"><i class="fas fa-th-large"></i></button>
                    <button data-view="list" class="view-btn text-gray-400 hover:text-red-600"><i class="fas fa-bars"></i></button>
                </div>
            </div>
        </div>

        <div id="loading-spinner" class="animate-spin rounded-full h-16 w-16 border-4 border-gray-300 mx-auto mt-20"></div>
        
        <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 sm:gap-6"></div>
        
       <div id="no-results" class="hidden text-center py-10">
            <p class="text-xl text-gray-500">No se encontraron productos.</p>
       </div>
    </div>

    <!-- Notificaciones -->
    <div id="copy-notification" class="notification fixed bottom-5 left-5 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 z-50">¡Info copiada!</div>
    <div id="cart-notification" class="notification fixed bottom-5 left-5 bg-green-600 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 z-50">¡Producto añadido!</div>
    <div id="saved-notification" class="notification fixed bottom-5 left-5 bg-blue-600 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 z-50">¡Pedido guardado!</div>
    <div id="offline-notification" class="hidden fixed top-0 left-0 right-0 bg-yellow-500 text-black text-center p-2 font-bold z-50">Modo Offline: Estás trabajando sin conexión.</div>
    <div id="sync-notification" class="hidden fixed top-0 left-0 right-0 bg-blue-500 text-white text-center p-2 font-bold z-50 cursor-pointer">¡Conexión recuperada! Tienes pedidos guardados. Haz clic para verlos.</div>


    <button id="cart-button" class="fixed bottom-5 right-5 bg-red-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl z-20">
        <i class="fas fa-shopping-cart"></i>
        <span id="cart-count" class="absolute -top-1 -right-1 bg-red-700 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center border-2 border-white">0</span>
    </button>
    
    <div id="cart-modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-30 items-center justify-center p-4">
        <div id="cart-modal" class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-full flex flex-col">
            <header class="p-4 border-b flex justify-between items-center"><h2 class="text-xl font-bold">Carrito de Pedido</h2><button id="close-cart-modal-button" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button></header>
            <main id="cart-items-container" class="p-4 overflow-y-auto flex-grow"></main>
            <footer class="p-4 border-t bg-gray-50">
                <div class="flex justify-between items-center mb-4"><span class="font-bold text-lg">Total:</span><span id="cart-total" class="font-bold text-lg text-red-700">$0.00</span></div>
                <input type="text" id="client-name-input" placeholder="Nombre del Cliente (para guardar)" class="w-full p-2 border rounded-lg mb-3">
                <div class="flex flex-col sm:flex-row gap-2">
                    <button id="clear-cart-button" class="w-full bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition">Vaciar</button>
                    <button id="save-cart-button" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2"><i class="fas fa-save"></i> Guardar</button>
                    <button id="share-whatsapp-button" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition flex items-center justify-center gap-2"><i class="fab fa-whatsapp"></i> Compartir</button>
                </div>
            </footer>
        </div>
    </div>
    
    <div id="saved-orders-modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-40 items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-full flex flex-col">
            <header class="p-4 border-b flex justify-between items-center"><h2 class="text-xl font-bold">Pedidos Guardados</h2><button id="close-saved-orders-modal-button" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button></header>
            <main id="saved-orders-container" class="p-4 overflow-y-auto flex-grow"></main>
        </div>
    </div>
    </div> </div> <div id="image-zoom-modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 z-50 items-center justify-center p-4 cursor-zoom-out">
        <div class="relative max-w-4xl max-h-[90vh]">
            <img id="zoomed-image" src="" alt="Vista ampliada del producto" class="block max-w-full max-h-full rounded-lg shadow-2xl">
            <button id="close-zoom-modal-button" class="absolute -top-4 -right-4 bg-white text-black w-10 h-10 rounded-full text-2xl font-bold flex items-center justify-center shadow-lg hover:bg-red-600 hover:text-white transition">&times;</button>
        </div>
    </div>
    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            // Selectores DOM
            const searchBox = document.getElementById('search-box');
            const categoryFilter = document.getElementById('category-filter');
            const subcategoryFilter = document.getElementById('subcategory-filter');
            const brandFilter = document.getElementById('brand-filter');
            const clearFiltersBtn = document.getElementById('clear-filters');
            const productGrid = document.getElementById('product-grid');
            const resultsCount = document.getElementById('results-count');
            const noResults = document.getElementById('no-results');
            const loadingSpinner = document.getElementById('loading-spinner');
            const cartButton = document.getElementById('cart-button');
            const cartCount = document.getElementById('cart-count');
            const cartModalOverlay = document.getElementById('cart-modal-overlay');
            const closeCartModalButton = document.getElementById('close-cart-modal-button');
            const cartItemsContainer = document.getElementById('cart-items-container');
            const cartTotal = document.getElementById('cart-total');
            const shareWhatsappButton = document.getElementById('share-whatsapp-button');
            const clearCartButton = document.getElementById('clear-cart-button');
            const clientNameInput = document.getElementById('client-name-input');
            const saveCartButton = document.getElementById('save-cart-button');
            const savedOrdersButton = document.getElementById('saved-orders-button');
            const savedOrdersModalOverlay = document.getElementById('saved-orders-modal-overlay');
            const closeSavedOrdersModalButton = document.getElementById('close-saved-orders-modal-button');
            const savedOrdersContainer = document.getElementById('saved-orders-container');
            const viewToggle = document.getElementById('view-toggle');
            const downloadCatalogButton = document.getElementById('download-catalog-button');
            const offlineNotification = document.getElementById('offline-notification');
            const syncNotification = document.getElementById('sync-notification');
            const imageZoomModalOverlay = document.getElementById('image-zoom-modal-overlay');
            const closeZoomModalButton = document.getElementById('close-zoom-modal-button');
            const zoomedImage = document.getElementById('zoomed-image');
        

            // Estado de la aplicación
            let allProducts = [];
            let cart = [];
            let currentView = 'grid'; 
            let savedCarts = JSON.parse(localStorage.getItem('savedCarts')) || [];
            let longPressTimer;
            const LONG_PRESS_DURATION = 500; // 500ms para un toque largo

            // Carga inicial de productos
            async function loadProducts() {
                try {
                    const response = await fetch('Resultado_Final.json');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    allProducts = await response.json();
                    populateFilters();
                    renderProducts();
                } catch (error) {
                    console.error("Error al cargar productos:", error);
                    productGrid.innerHTML = `<p class="col-span-full text-center text-red-600 font-bold">Error: No se pudo cargar el catálogo. Intenta usar el modo offline si lo descargaste.</p>`;
                } finally {
                    loadingSpinner.style.display = 'none';
                }
            }

            function populateFilters() {
                const categories = [...new Set(allProducts.map(p => p.Categoría))].sort();
                const brands = [...new Set(allProducts.map(p => p.Marca).filter(Boolean))].sort();

                categoryFilter.innerHTML = '<option value="">Todas las Categorías</option>';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat; option.textContent = cat;
                    categoryFilter.appendChild(option);
                });
                
                brandFilter.innerHTML = '<option value="">Todas las Marcas</option>';
                brands.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand; option.textContent = brand;
                    brandFilter.appendChild(option);
                });
            }
            
            function updateSubcategories() {
                const selectedCategory = categoryFilter.value;
                subcategoryFilter.innerHTML = '<option value="">Todas las Subcategorías</option>';
                if (selectedCategory) {
                    const relevantSubcategories = [...new Set(allProducts.filter(p => p.Categoría === selectedCategory && p.Subcategoría).map(p => p.Subcategoría))].sort();
                    relevantSubcategories.forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub; option.textContent = sub;
                        subcategoryFilter.appendChild(option);
                    });
                }
                renderProducts();
            }

            function renderProducts() {
                const searchTerm = searchBox.value.toLowerCase();
                const selectedCategory = categoryFilter.value;
                const selectedSubcategory = subcategoryFilter.value;
                const selectedBrand = brandFilter.value;

                const filteredProducts = allProducts.filter(p => 
                    (searchTerm === '' || p.Nombre?.toLowerCase().includes(searchTerm) || p['Referencia Interna']?.toLowerCase().includes(searchTerm) || p.Marca?.toLowerCase().includes(searchTerm)) &&
                    (selectedCategory === '' || p.Categoría === selectedCategory) &&
                    (selectedSubcategory === '' || p.Subcategoría === selectedSubcategory) &&
                    (selectedBrand === '' || p.Marca === selectedBrand)
                );

                productGrid.innerHTML = '';
                productGrid.className = currentView === 'grid' 
                    ? 'grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 sm:gap-6' 
                    : 'flex flex-col gap-3';
                noResults.classList.toggle('hidden', filteredProducts.length > 0);
                resultsCount.textContent = `${filteredProducts.length} producto(s)`;
                filteredProducts.forEach(p => productGrid.appendChild(createProductCard(p)));
            }
            
            function createProductCard(product) {
                const card = document.createElement('div');
                const ref = product['Referencia Interna'];
                const price = product.Precio ? '$' + parseFloat(product.Precio).toFixed(2) : 'N/A';
                const stock = product.Stock || 0;
                const imagePath = `images/${ref}.webp`;
                const itemInCart = cart.find(item => item.ref === ref);
                const quantityInCart = itemInCart ? itemInCart.quantity : 0;
                const stockIndicator = stock > 10 ? '<span class="w-3 h-3 bg-green-500 rounded-full"></span>' : stock > 0 ? '<span class="w-3 h-3 bg-yellow-500 rounded-full"></span>' : '<span class="w-3 h-3 bg-red-500 rounded-full"></span>';
                
                let cardHTML = '';
                if (currentView === 'grid') {
                    card.className = 'bg-white rounded-lg shadow-md overflow-hidden flex flex-col transition-transform transform hover:-translate-y-1';
                    cardHTML = `
                        <div class="aspect-square bg-gray-200 flex items-center justify-center overflow-hidden">
                            <img src="${imagePath}" alt="${product.Nombre}" class="w-full h-full object-cover zoomable-image cursor-zoom-in" loading="lazy" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';">
                        </div>
                        <div class="p-3 flex-grow flex flex-col text-sm">
                            <h3 class="font-bold text-gray-800 flex-grow">${product.Nombre || 'Sin Nombre'}</h3><p class="text-xs text-gray-500 mt-1">${ref || ''}</p>
                            <p class="text-xs text-white bg-red-600 px-2 py-1 rounded-full self-start mt-2">${product.Categoría || ''}</p>
                            <div class="mt-3 pt-3 border-t flex justify-between items-center"><div class="flex items-center gap-1">${stockIndicator} <p class="font-bold">${stock}</p></div><p class="font-bold text-md text-red-700">${price}</p></div>
                        </div>
                        <div class="flex relative">
                            ${quantityInCart > 0 ? `<span class="absolute top-[-10px] right-[-5px] bg-blue-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">${quantityInCart}</span>` : ''}
                            <button class="copy-button w-3/4 bg-gray-200 text-gray-700 text-xs py-2 hover:bg-red-600 hover:text-white transition-colors" data-info="Producto: ${product.Nombre || ''}\nRef: ${ref || ''}\nPrecio: ${price}"><i class="fas fa-copy mr-1"></i> Copiar</button>
                            <button class="add-to-cart-button w-1/4 bg-red-600 text-white text-lg hover:bg-red-700 transition-colors" data-ref="${ref}"><i class="fas fa-plus"></i></button>
                        </div>`;
                } else { // Vista de lista
                    card.className = 'bg-white rounded-lg shadow-md overflow-hidden flex items-center p-3 gap-4 w-full';
                    cardHTML = `
                        <img src="${imagePath}" alt="${product.Nombre}" class="w-20 h-20 object-cover bg-gray-200 rounded-md zoomable-image cursor-zoom-in" loading="lazy" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';">
                        <div class="flex-grow"><h3 class="font-bold text-gray-800">${product.Nombre || 'Sin Nombre'}</h3><p class="text-sm text-gray-500">${ref || ''}</p><div class="flex items-center gap-4 mt-1"><p class="text-sm text-white bg-red-600 px-2 py-1 rounded-full">${product.Categoría || ''}</p><div class="flex items-center gap-1">${stockIndicator} <p class="font-bold">${stock}</p></div></div></div>
                        <div class="flex flex-col items-end gap-2"><p class="font-bold text-lg text-red-700">${price}</p>
                            <div class="flex relative">
                                ${quantityInCart > 0 ? `<span class="absolute top-[-10px] right-[-5px] bg-blue-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">${quantityInCart}</span>` : ''}
                                <button class="copy-button p-2 bg-gray-200 text-gray-700 rounded-l-md hover:bg-red-600 hover:text-white transition-colors" data-info="Producto: ${product.Nombre || ''}\nRef: ${ref || ''}\nPrecio: ${price}"><i class="fas fa-copy"></i></button>
                                <button class="add-to-cart-button p-2 bg-red-600 text-white rounded-r-md hover:bg-red-700 transition-colors" data-ref="${ref}"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>`;
                }
                card.innerHTML = cardHTML;
                card.dataset.ref = ref;
                return card;
            }

            function updateProductCard(ref) {
                const cards = document.querySelectorAll(`[data-ref="${ref}"]`);
                if (cards.length > 0) {
                    const product = allProducts.find(p => p['Referencia Interna'] === ref);
                    if (product) {
                        cards.forEach(card => card.replaceWith(createProductCard(product)));
                    }
                }
            }
            
            function addToCart(ref, buttonElement, quantity = 1) {
                if (quantity <= 0) return;
                const existingProduct = cart.find(item => item.ref === ref);
                if (existingProduct) {
                    existingProduct.quantity += quantity;
                } else {
                    const product = allProducts.find(p => p['Referencia Interna'] === ref);
                    if (product) cart.push({ ref: ref, quantity: quantity, product: product });
                }
                updateCart();
                updateProductCard(ref);

                if (quantity === 1) {
                    showNotification('cart-notification');
                    if (buttonElement) {
                        const icon = buttonElement.querySelector('i');
                        buttonElement.classList.add('bg-green-500'); icon.classList.replace('fa-plus', 'fa-check');
                        setTimeout(() => {
                            buttonElement.classList.remove('bg-green-500'); icon.classList.replace('fa-check', 'fa-plus');
                        }, 1000);
                    }
                }
            }
            
            function handleAddToCartPress(button) {
                longPressTimer = setTimeout(() => {
                    const ref = button.dataset.ref;
                    const productName = allProducts.find(p => p['Referencia Interna'] === ref)?.Nombre || ref;
                    const quantityStr = prompt(`¿Cuántas unidades de "${productName}" quieres añadir?`, 1);
                    const quantity = parseInt(quantityStr, 10);
                    if (!isNaN(quantity) && quantity > 0) {
                        addToCart(ref, button, quantity);
                        showNotification('cart-notification');
                    }
                }, LONG_PRESS_DURATION);
            }

            function handleAddToCartRelease() {
                clearTimeout(longPressTimer);
            }

            productGrid.addEventListener('click', e => {
                const copyBtn = e.target.closest('.copy-button');
                if (copyBtn) {
                    navigator.clipboard.writeText(copyBtn.dataset.info).then(() => showNotification('copy-notification'));
                    return;
                }
                const cartBtn = e.target.closest('.add-to-cart-button');
                if (cartBtn) {
                    addToCart(cartBtn.dataset.ref, cartBtn, 1);
                }
                const zoomTrigger = e.target.closest('.zoomable-image');
                if (zoomTrigger) {
                    zoomedImage.src = zoomTrigger.src;
                    imageZoomModalOverlay.classList.add('flex');
                }
            });

            productGrid.addEventListener('mousedown', e => {
                const cartBtn = e.target.closest('.add-to-cart-button');
                if (cartBtn) handleAddToCartPress(cartBtn);
            });
            
            productGrid.addEventListener('mouseup', e => {
                 const cartBtn = e.target.closest('.add-to-cart-button');
                if (cartBtn) handleAddToCartRelease();
            });

            productGrid.addEventListener('mouseleave', e => {
                const cartBtn = e.target.closest('.add-to-cart-button');
                if (cartBtn) handleAddToCartRelease();
            }, true);
            
            productGrid.addEventListener('touchstart', e => {
                 const cartBtn = e.target.closest('.add-to-cart-button');
                if (cartBtn) handleAddToCartPress(cartBtn);
            });

            productGrid.addEventListener('touchend', e => {
                 const cartBtn = e.target.closest('.add-to-cart-button');
                if (cartBtn) handleAddToCartRelease();
            });

            function changeQuantity(ref, change) {
                const itemInCart = cart.find(item => item.ref === ref);
                if (itemInCart) {
                    itemInCart.quantity += change;
                    if (itemInCart.quantity <= 0) cart = cart.filter(item => item.ref !== ref);
                }
                updateCart();
                renderProducts();
            }
            
            function updateCart() {
                renderCart();
                cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
                cartTotal.textContent = `$${cart.reduce((sum, item) => sum + ((parseFloat(item.product.Precio) || 0) * item.quantity), 0).toFixed(2)}`;
            }

            function renderCart() {
                if (cart.length === 0) {
                    cartItemsContainer.innerHTML = '<p class="text-gray-500">Tu carrito está vacío.</p>';
                    return;
                }
                
                // AJUSTE: Asegúrate de que esta línea completa sea la que tienes
                cartItemsContainer.innerHTML = cart.map(item => {
                    const imagePath = `images/${item.ref}.webp`;
                    const price = parseFloat(item.product.Precio) || 0;
                    return `
                        <div class="flex items-center justify-between border-b py-3 gap-3">
                            <img src="${imagePath}" alt="${item.product.Nombre}" class="w-16 h-16 object-cover rounded-md bg-gray-200 flex-shrink-0" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';">
                            <div class="flex-grow min-w-0">
                                <p class="font-bold truncate text-sm sm:text-base">${item.product.Nombre}</p>
                                <p class="text-xs text-gray-500 truncate">${item.ref}</p>
                                <p class="text-sm font-semibold text-red-600">$${price.toFixed(2)}</p>
                            </div>
                            <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
                                <button class="change-quantity-button bg-gray-200 w-7 h-7 sm:w-8 sm:h-8 rounded-full font-bold flex items-center justify-center" data-ref="${item.ref}" data-change="-1">-</button>
                                <span class="font-bold w-6 text-center text-sm sm:text-base">${item.quantity}</span>
                                <button class="change-quantity-button bg-gray-200 w-7 h-7 sm:w-8 sm:h-8 rounded-full font-bold flex items-center justify-center" data-ref="${item.ref}" data-change="1">+</button>
                            </div>
                        </div>`;
                }).join(''); // <-- Esto une los productos sin añadir nada extra.
            }
                
            function shareOnWhatsApp() {
                if (!navigator.onLine) {
                    alert("Necesitas conexión a internet para compartir por WhatsApp. El pedido se ha guardado localmente.");
                    return;
                }
                if (cart.length === 0) return;
                let message = clientNameInput.value ? `*Pedido para: ${clientNameInput.value}*\n\n` : `*¡Hola! Te comparto este pedido:*\n\n`;
                let total = 0;
                cart.forEach(item => {
                    const price = parseFloat(item.product.Precio) || 0;
                    const subtotal = price * item.quantity;
                    total += subtotal;
                    message += `*${item.product.Nombre}*\nRef: ${item.ref}\n${item.quantity} x $${price.toFixed(2)} = *$${subtotal.toFixed(2)}*\n\n`;
                });
                message += `*TOTAL DEL PEDIDO: $${total.toFixed(2)}*`;
                window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`, '_blank');
            }

            function saveCurrentCart() {
                const clientName = clientNameInput.value.trim();
                if (cart.length === 0 || !clientName) { alert("Por favor, ingresa un nombre de cliente y añade productos para guardar."); return; }
                const newOrder = { 
                    id: Date.now(), 
                    clientName: clientName, 
                    items: JSON.parse(JSON.stringify(cart)), 
                    total: cart.reduce((sum, item) => sum + ((parseFloat(item.product.Precio) || 0) * item.quantity), 0),
                    synced: navigator.onLine
                };
                savedCarts.push(newOrder);
                localStorage.setItem('savedCarts', JSON.stringify(savedCarts));
                clientNameInput.value = ''; cartModalOverlay.classList.remove('flex'); showNotification('saved-notification');
            }

            function renderSavedCarts() {
                if (savedCarts.length === 0) { savedOrdersContainer.innerHTML = '<p class="text-gray-500">No hay pedidos guardados.</p>'; return; }
                savedOrdersContainer.innerHTML = savedCarts.map(saved => `
                    <div class="flex items-center justify-between border-b py-3 gap-2">
                        <div class="flex-grow min-w-0">
                           <div class="flex items-center gap-2">
                             ${!saved.synced ? '<i class="fas fa-exclamation-triangle text-yellow-500" title="Guardado sin conexión"></i>' : ''}
                             <p class="font-bold truncate">${saved.clientName}</p>
                           </div>
                           <p class="text-sm text-gray-500">${saved.items.length} tipo(s) de producto</p>
                           <p class="text-sm font-semibold text-red-600">$${saved.total.toFixed(2)}</p>
                        </div>
                        <div class="flex gap-2"><button class="load-cart-button bg-green-500 text-white py-1 px-3 rounded hover:bg-green-600" data-id="${saved.id}">Cargar</button><button class="delete-cart-button bg-red-600 text-white py-1 px-3 rounded hover:bg-red-700" data-id="${saved.id}">Borrar</button></div>
                    </div>`).join('');
            }
            
            function loadSavedCart(id) {
                const saved = savedCarts.find(s => s.id == id);
                if (saved) {
                    cart = JSON.parse(JSON.stringify(saved.items));
                    clientNameInput.value = saved.clientName;
                    updateCart(); renderProducts();
                    savedOrdersModalOverlay.classList.remove('flex');
                    cartModalOverlay.classList.add('flex');
                }
            }

            function deleteSavedCart(id) {
                if (confirm("¿Estás seguro de que quieres borrar este pedido guardado?")) {
                    savedCarts = savedCarts.filter(s => s.id != id);
                    localStorage.setItem('savedCarts', JSON.stringify(savedCarts));
                    renderSavedCarts();
                }
            }

            function showNotification(id) {
                const n = document.getElementById(id);
                n.classList.add('opacity-100', 'translate-y-0'); n.classList.remove('opacity-0', 'translate-y-2');
                setTimeout(() => { n.classList.remove('opacity-100', 'translate-y-0'); n.classList.add('opacity-0', 'translate-y-2'); }, 2000);
            }

            function updateOnlineStatus() {
                if (navigator.onLine) {
                    offlineNotification.classList.add('hidden');
                    const unsyncedCarts = savedCarts.some(cart => !cart.synced);
                    if (unsyncedCarts) {
                        syncNotification.classList.remove('hidden');
                    }
                } else {
                    offlineNotification.classList.remove('hidden');
                    syncNotification.classList.add('hidden');
                }
            }

            downloadCatalogButton.addEventListener('click', () => {
                if (!('serviceWorker' in navigator) || !navigator.serviceWorker.controller) {
                    alert('El Service Worker no está activo. Por favor, refresca la página e inténtalo de nuevo.');
                    return;
                }
                if(allProducts.length === 0) {
                    alert('Espera a que los productos carguen primero.');
                    return;
                }
                const originalText = downloadCatalogButton.innerHTML;
                downloadCatalogButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> <span class="hidden sm:inline">Descargando...</span>`;
                downloadCatalogButton.disabled = true;

                const imageUrls = allProducts.map(p => `images/${p['Referencia Interna']}.webp`);
                navigator.serviceWorker.controller.postMessage({
                    type: 'CACHE_IMAGES',
                    urls: imageUrls
                });
                
                navigator.serviceWorker.addEventListener('message', event => {
                    if (event.data.type === 'CACHE_COMPLETE') {
                        alert('¡Catálogo descargado! La aplicación ahora está lista para funcionar offline.');
                        downloadCatalogButton.innerHTML = originalText;
                        downloadCatalogButton.disabled = false;
                    }
                }, { once: true });
            });

            function handleSyncNotificationClick() {
                renderSavedCarts();
                savedOrdersModalOverlay.classList.add('flex');
                syncNotification.classList.add('hidden');
            }
            
            syncNotification.addEventListener('click', handleSyncNotificationClick);
            syncNotification.addEventListener('touchend', handleSyncNotificationClick);

            searchBox.addEventListener('input', renderProducts);
            categoryFilter.addEventListener('change', updateSubcategories);
            subcategoryFilter.addEventListener('change', renderProducts);
            brandFilter.addEventListener('change', renderProducts);
            clearFiltersBtn.addEventListener('click', () => { searchBox.value = ''; categoryFilter.value = ''; brandFilter.value = ''; updateSubcategories(); });
            cartButton.addEventListener('click', () => cartModalOverlay.classList.add('flex'));
            closeCartModalButton.addEventListener('click', () => cartModalOverlay.classList.remove('flex'));
            clearCartButton.addEventListener('click', () => { cart = []; updateCart(); renderProducts(); });
            shareWhatsappButton.addEventListener('click', shareOnWhatsApp);
            cartItemsContainer.addEventListener('click', e => { const btn = e.target.closest('.change-quantity-button'); if(btn) changeQuantity(btn.dataset.ref, parseInt(btn.dataset.change, 10)); });
            saveCartButton.addEventListener('click', saveCurrentCart);
            savedOrdersButton.addEventListener('click', () => { renderSavedCarts(); savedOrdersModalOverlay.classList.add('flex'); });
            closeSavedOrdersModalButton.addEventListener('click', () => savedOrdersModalOverlay.classList.remove('flex'));
            savedOrdersContainer.addEventListener('click', e => {
                if (e.target.closest('.load-cart-button')) loadSavedCart(e.target.closest('.load-cart-button').dataset.id);
                if (e.target.closest('.delete-cart-button')) deleteSavedCart(e.target.closest('.delete-cart-button').dataset.id);
            });
            viewToggle.addEventListener('click', e => {
                const btn = e.target.closest('.view-btn');
                if (btn && !btn.classList.contains('text-red-600')) {
                    currentView = btn.dataset.view;
                    document.querySelectorAll('.view-btn').forEach(b => { b.classList.remove('text-red-600'); b.classList.add('text-gray-400'); });
                    btn.classList.add('text-red-600'); btn.classList.remove('text-gray-400');
                    renderProducts();
                }
            });

            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => { 
                    navigator.serviceWorker.register('./sw.js')
                        .then(reg => console.log('SW registrado con éxito.'))
                        .catch(err => console.error('Error en el registro del SW', err));
                });

            }
            const closeZoomModal = () => {
                imageZoomModalOverlay.classList.remove('flex');
                zoomedImage.src = ""; // Limpiamos la imagen para liberar memoria
            };

            closeZoomModalButton.addEventListener('click', closeZoomModal);

            imageZoomModalOverlay.addEventListener('click', (e) => {
                // Cierra el modal solo si se hace clic en el fondo (el overlay)
                if (e.target === imageZoomModalOverlay) {
                    closeZoomModal();
                }
            });
            loadProducts();
            updateOnlineStatus();
        });
    </script>
</body>
</html>

