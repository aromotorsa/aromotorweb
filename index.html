<!DOCTYPE html>
<html lang="es" class="bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat√°logo de Productos - Aromotor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#EF4444"/>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        #loading-spinner { border-top-color: #EF4444; }
        .notification { transition: all 0.3s ease-in-out; }
        .modal-overlay { display: none; }
        .modal-overlay.flex { display: flex; }
        
        #quotation-content main {
            overflow-y: auto;
        }
    </style>
</head>
<body class="antialiased font-sans">

    <div id="app" class="container mx-auto p-4">

        <header class="bg-white rounded-lg shadow-md p-4 mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="flex items-center min-w-0">
                <img src="logos/AROMOTOR.png" alt="Logo Empresa" class="h-10 mr-3 flex-shrink-0">
            </div>
            <div class="flex items-center gap-2 sm:gap-4 flex-wrap justify-center">
                <button id="download-catalog-button" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2" title="Descargar cat√°logo para uso offline">
                    <i class="fas fa-cloud-download-alt"></i>
                    <span class="hidden sm:inline">Offline</span>
                </button>
                <button id="saved-orders-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                    <i class="fas fa-save"></i>
                    <span class="hidden sm:inline">Pedidos</span>
                </button>
            </div>
        </header>
        
        <!-- CAMBIO: Panel de filtros redise√±ado para mayor claridad y funcionalidad -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="space-y-4">
                <input type="search" id="search-box" placeholder="Buscar por nombre, referencia..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition">
                <div class="grid grid-cols-2 gap-4">
                    <select id="category-filter" class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-red-500 focus:border-transparent transition">
                        <option value="">Grupo</option>
                    </select>
                    <select id="subcategory-filter" class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-red-500 focus:border-transparent transition">
                        <option value="">Categor√≠a</option>
                    </select>
                    <select id="type-filter" class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-red-500 focus:border-transparent transition">
                         <option value="">Subcategor√≠a</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-between items-center mt-4">
                <div>
                    <p id="results-count" class="text-gray-600 text-sm"></p>
                    <button id="clear-filters" class="text-sm text-red-600 hover:text-red-800 font-semibold">Limpiar Filtros</button>
                </div>
                <div id="view-toggle" class="text-xl flex gap-3">
                    <button data-view="grid" class="view-btn text-red-600"><i class="fas fa-th-large"></i></button>
                    <button data-view="list" class="view-btn text-gray-400 hover:text-red-600"><i class="fas fa-bars"></i></button>
                </div>
            </div>
        </div>

        <div id="loading-spinner" class="animate-spin rounded-full h-16 w-16 border-4 border-gray-300 mx-auto mt-20"></div>
        
        <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 sm:gap-6"></div>
        
       <div id="no-results" class="hidden text-center py-10">
            <p class="text-xl text-gray-500">No se encontraron productos.</p>
       </div>
    </div>

    <!-- Notificaciones y Modales (sin cambios estructurales) -->
    <div id="copy-notification" class="notification fixed bottom-5 left-5 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 z-50">¬°Info copiada!</div>
    <div id="cart-notification" class="notification fixed bottom-5 left-5 bg-green-600 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 z-50">¬°Producto a√±adido!</div>
    <div id="saved-notification" class="notification fixed bottom-5 left-5 bg-blue-600 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 z-50">¬°Pedido guardado!</div>
    <div id="offline-notification" class="hidden fixed top-0 left-0 right-0 bg-yellow-500 text-black text-center p-2 font-bold z-50">Modo Offline: Est√°s trabajando sin conexi√≥n.</div>
    <div id="sync-notification" class="hidden fixed top-0 left-0 right-0 bg-blue-500 text-white text-center p-2 font-bold z-50 cursor-pointer">¬°Conexi√≥n recuperada! Tienes pedidos guardados. Haz clic para verlos.</div>


    <button id="cart-button" class="fixed bottom-5 right-5 bg-red-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl z-20">
        <i class="fas fa-shopping-cart"></i>
        <span id="cart-count" class="absolute -top-1 -right-1 bg-red-700 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center border-2 border-white">0</span>
    </button>
    
    <div id="cart-modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-30 items-center justify-center p-2 sm:p-4">
        <div id="quotation-content" class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            
            <header class="p-4 border-b flex justify-between items-center flex-shrink-0">
                <div>
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Cotizaci√≥n de Pedido</h2>
                    <p id="quotation-date" class="text-sm text-gray-500"></p>
                </div>
                <button id="close-cart-modal-button" class="text-3xl text-gray-400 hover:text-red-600 transition-transform transform hover:rotate-90">&times;</button>
            </header>
            
            <div class="p-4 border-b flex-shrink-0">
                <label for="client-name-input" class="block text-sm font-medium text-gray-700 mb-1">Cliente:</label>
                <input type="text" id="client-name-input" placeholder="Nombre del Cliente" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 transition">
            </div>

            <main class="flex-grow bg-gray-50 p-4">
                <div id="cart-items-container" class="space-y-4">
                    </div>
            </main>
            
            <footer class="p-4 border-t bg-white flex-shrink-0">
                <div class="flex justify-end items-center mb-4">
                    <span class="text-gray-600 font-medium mr-4">Total:</span>
                    <span id="cart-total" class="font-bold text-2xl text-red-700">$0.00</span>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                    <button id="clear-cart-button" class="w-full bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition">Vaciar</button>
                    <button id="save-cart-button" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2"><i class="fas fa-save"></i> Guardar</button>
                    <button id="share-whatsapp-button" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition flex items-center justify-center gap-2"><i class="fab fa-whatsapp"></i> Compartir</button>
                </div>
            </footer>
        </div>
    </div>

    
    <div id="saved-orders-modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-40 items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-full flex flex-col">
            <header class="p-4 border-b flex justify-between items-center"><h2 class="text-xl font-bold">Pedidos Guardados</h2><button id="close-saved-orders-modal-button" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button></header>
            <main id="saved-orders-container" class="p-4 overflow-y-auto flex-grow"></main>
        </div>
    </div> 
    
    <div id="image-zoom-modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 z-50 items-center justify-center p-4 cursor-zoom-out">
        <div class="relative max-w-4xl max-h-[90vh]">
            <img id="zoomed-image" src="" alt="Vista ampliada del producto" class="block max-w-full max-h-full rounded-lg shadow-2xl">
            <button id="close-zoom-modal-button" class="absolute -top-4 -right-4 bg-white text-black w-10 h-10 rounded-full text-2xl font-bold flex items-center justify-center shadow-lg hover:bg-red-600 hover:text-white transition">&times;</button>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CAMBIO: Selectores DOM actualizados ---
            const searchBox = document.getElementById('search-box');
            const categoryFilter = document.getElementById('category-filter');
            const subcategoryFilter = document.getElementById('subcategory-filter');
            const typeFilter = document.getElementById('type-filter'); // Nuevo selector
            const clearFiltersBtn = document.getElementById('clear-filters');
            const productGrid = document.getElementById('product-grid');
            const resultsCount = document.getElementById('results-count');
            const noResults = document.getElementById('no-results');
            const loadingSpinner = document.getElementById('loading-spinner');
            // (El resto de selectores permanecen igual)
            const cartButton = document.getElementById('cart-button');
            const cartCount = document.getElementById('cart-count');
            const cartModalOverlay = document.getElementById('cart-modal-overlay');
            const closeCartModalButton = document.getElementById('close-cart-modal-button');
            const cartItemsContainer = document.getElementById('cart-items-container');
            const cartTotal = document.getElementById('cart-total');
            const shareWhatsappButton = document.getElementById('share-whatsapp-button');
            const clearCartButton = document.getElementById('clear-cart-button');
            const clientNameInput = document.getElementById('client-name-input');
            const saveCartButton = document.getElementById('save-cart-button');
            const savedOrdersButton = document.getElementById('saved-orders-button');
            const savedOrdersModalOverlay = document.getElementById('saved-orders-modal-overlay');
            const closeSavedOrdersModalButton = document.getElementById('close-saved-orders-modal-button');
            const savedOrdersContainer = document.getElementById('saved-orders-container');
            const viewToggle = document.getElementById('view-toggle');
            const downloadCatalogButton = document.getElementById('download-catalog-button');
            const offlineNotification = document.getElementById('offline-notification');
            const syncNotification = document.getElementById('sync-notification');
            const imageZoomModalOverlay = document.getElementById('image-zoom-modal-overlay');
            const closeZoomModalButton = document.getElementById('close-zoom-modal-button');
            const zoomedImage = document.getElementById('zoomed-image');
    
            // Estado de la aplicaci√≥n
            let allProducts = [];
            let cart = [];
            let currentView = 'grid'; 
            let savedCarts = JSON.parse(localStorage.getItem('savedCarts')) || [];
            let longPressTimer;
            const LONG_PRESS_DURATION = 500; 

            // Carga inicial de productos
            async function loadProducts() {
                try {
                    const response = await fetch('Resultado_Final.json?v=' + new Date().getTime()); // Evita cach√©
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    allProducts = await response.json();
                    populateFilters();
                    renderProducts();
                } catch (error) {
                    console.error("Error al cargar productos:", error);
                    productGrid.innerHTML = `<p class="col-span-full text-center text-red-600 font-bold">Error: No se pudo cargar el cat√°logo. Intenta usar el modo offline si lo descargaste.</p>`;
                } finally {
                    loadingSpinner.style.display = 'none';
                }
            }

            // --- CAMBIO: L√≥gica de filtros reescrita para ser m√°s inteligente y conectada ---

            function populateFilters() {
                const categories = [...new Set(allProducts.map(p => p.Categor√≠a).filter(Boolean))].sort();
                updateSelect(categoryFilter, categories, 'Grupo');

                // Initially populate subcategories and types with all values
                const allSubcategories = [...new Set(allProducts.map(p => p.Subcategor√≠a).filter(Boolean))].sort();
                updateSelect(subcategoryFilter, allSubcategories, 'Categor√≠a');

                const allTypes = [...new Set(allProducts.map(p => p.Tipo).filter(Boolean))].sort();
                updateSelect(typeFilter, allTypes, 'Subcategor√≠a');
            }

            function updateSelect(selectElement, options, placeholder) {
                const currentValue = selectElement.value;
                selectElement.innerHTML = `<option value="">${placeholder}</option>`;
                options.forEach(optionValue => {
                    const option = document.createElement('option');
                    option.value = optionValue; 
                    option.textContent = optionValue;
                    selectElement.appendChild(option);
                });
                
                if (options.includes(currentValue)) {
                    selectElement.value = currentValue;
                } else {
                    selectElement.value = '';
                }
            }

            function updateFiltersAndRender() {
                let availableProducts = [...allProducts];

                const selectedCategory = categoryFilter.value;
                const selectedSubcategory = subcategoryFilter.value;

                if (selectedCategory) {
                    availableProducts = availableProducts.filter(p => p.Categor√≠a === selectedCategory);
                }

                const availableSubcategories = [...new Set(availableProducts.map(p => p.Subcategor√≠a).filter(Boolean))].sort();
                updateSelect(subcategoryFilter, availableSubcategories, 'Categor√≠a');
                
                if (selectedCategory && availableSubcategories.includes(selectedSubcategory)) {
                    subcategoryFilter.value = selectedSubcategory;
                    availableProducts = availableProducts.filter(p => p.Subcategor√≠a === selectedSubcategory);
                } else {
                    subcategoryFilter.value = '';
                }

                const availableTypes = [...new Set(availableProducts.map(p => p.Tipo).filter(Boolean))].sort();
                updateSelect(typeFilter, availableTypes, 'Subcategor√≠a');

                renderProducts();
            }

            // Renderiza los productos aplicando TODOS los filtros actuales
            function renderProducts() {
                const searchTerm = searchBox.value.toLowerCase();
                const selectedCategory = categoryFilter.value;
                const selectedSubcategory = subcategoryFilter.value;
                const selectedType = typeFilter.value; // Nuevo valor de filtro

                const filteredProducts = allProducts.filter(p => 
                    (searchTerm === '' || p.Nombre?.toLowerCase().includes(searchTerm) || p['Referencia Interna']?.toLowerCase().includes(searchTerm) || p.Marca?.toLowerCase().includes(searchTerm)) &&
                    (selectedCategory === '' || p.Categor√≠a === selectedCategory) &&
                    (selectedSubcategory === '' || p.Subcategor√≠a === selectedSubcategory) &&
                    (selectedType === '' || p.Tipo === selectedType) // Nueva condici√≥n de filtro
                );

                productGrid.innerHTML = '';
                productGrid.className = currentView === 'grid' 
                    ? 'grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 sm:gap-6' 
                    : 'flex flex-col gap-3';
                noResults.classList.toggle('hidden', filteredProducts.length > 0);
                resultsCount.textContent = `${filteredProducts.length} producto(s)`;
                filteredProducts.forEach(p => productGrid.appendChild(createProductCard(p)));
            }
            
            function createProductCard(product) {
                const card = document.createElement('div');
                const ref = product['Referencia Interna'];
                const price = product.Precio ? '$' + parseFloat(product.Precio).toFixed(2) : 'N/A';
                const stock = product.Stock || 0;
                const imagePath = `images/${ref}.webp`;
                const itemInCart = cart.find(item => item.ref === ref);
                const quantityInCart = itemInCart ? itemInCart.quantity : 0;
                const stockIndicator = stock > 10 ? '<span class="w-3 h-3 bg-green-500 rounded-full"></span>' : stock > 0 ? '<span class="w-3 h-3 bg-yellow-500 rounded-full"></span>' : '<span class="w-3 h-3 bg-red-500 rounded-full"></span>';
                
                // --- CAMBIO: Muestra la ruta de categor√≠a completa (breadcrumb) ---
                const categoryPath = [product.Categor√≠a, product.Subcategor√≠a, product.Tipo]
                    .filter(c => c && c !== 'No Clasificado' && c !== 'N/A')
                    .join(' <span class="mx-1 text-gray-400">&gt;</span> ');
                
                let cardHTML = '';
                if (currentView === 'grid') {
                    card.className = 'bg-white rounded-lg shadow-md overflow-hidden flex flex-col transition-transform transform hover:-translate-y-1';
                    cardHTML = `
                        <div class="aspect-square bg-gray-200 flex items-center justify-center overflow-hidden">
                            <img src="${imagePath}" alt="${product.Nombre}" class="w-full h-full object-cover zoomable-image cursor-zoom-in" loading="lazy" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';">
                        </div>
                        <div class="p-3 flex-grow flex flex-col text-sm">
                            <h3 class="font-bold text-gray-800 flex-grow">${product.Nombre || 'Sin Nombre'}</h3>
                            <p class="text-xs text-gray-500 mt-1">${ref || ''}</p>
                            <div class="text-xs text-gray-600 mt-2 leading-tight">${categoryPath}</div>
                            <div class="mt-3 pt-3 border-t flex justify-between items-center">
                                <div class="flex items-center gap-1">${stockIndicator} <p class="font-bold">${stock}</p></div>
                                <p class="font-bold text-md text-red-700">${price}</p>
                            </div>
                        </div>
                        <div class="flex relative">
                            ${quantityInCart > 0 ? `<span class="absolute top-[-10px] right-[-5px] bg-blue-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">${quantityInCart}</span>` : ''}
                            <button class="copy-button w-3/4 bg-gray-200 text-gray-700 text-xs py-2 hover:bg-red-600 hover:text-white transition-colors" data-info="Producto: ${product.Nombre || ''}\nRef: ${ref || ''}\nPrecio: ${price}"><i class="fas fa-copy mr-1"></i> Copiar</button>
                            <button class="add-to-cart-button w-1/4 bg-red-600 text-white text-lg hover:bg-red-700 transition-colors" data-ref="${ref}"><i class="fas fa-plus"></i></button>
                        </div>`;
                } else { // Vista de lista
                    card.className = 'bg-white rounded-lg shadow-md overflow-hidden flex items-center p-3 gap-4 w-full';
                    cardHTML = `
                        <img src="${imagePath}" alt="${product.Nombre}" class="w-20 h-20 object-cover bg-gray-200 rounded-md zoomable-image cursor-zoom-in flex-shrink-0" loading="lazy" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';">
                        <div class="flex-grow">
                            <h3 class="font-bold text-gray-800">${product.Nombre || 'Sin Nombre'}</h3>
                            <p class="text-sm text-gray-500">${ref || ''}</p>
                            <div class="flex items-center gap-4 mt-1">
                                <div class="text-xs text-gray-600 leading-tight">${categoryPath}</div>
                                <div class="flex items-center gap-1">${stockIndicator} <p class="font-bold">${stock}</p></div>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <p class="font-bold text-lg text-red-700">${price}</p>
                            <div class="flex relative">
                                ${quantityInCart > 0 ? `<span class="absolute top-[-10px] right-[-5px] bg-blue-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">${quantityInCart}</span>` : ''}
                                <button class="copy-button p-2 bg-gray-200 text-gray-700 rounded-l-md hover:bg-red-600 hover:text-white transition-colors" data-info="Producto: ${product.Nombre || ''}\nRef: ${ref || ''}\nPrecio: ${price}"><i class="fas fa-copy"></i></button>
                                <button class="add-to-cart-button p-2 bg-red-600 text-white rounded-r-md hover:bg-red-700 transition-colors" data-ref="${ref}"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>`;
                }
                card.innerHTML = cardHTML;
                card.dataset.ref = ref;
                return card;
            }
            
            // --- El resto de funciones (carrito, guardado, etc.) permanecen igual ---
            
            function addToCart(ref, buttonElement, quantity = 1) {
                if (quantity <= 0) return;
                const product = allProducts.find(p => p['Referencia Interna'] === ref);
                if (!product) return;
                const stock = product.Stock || 0;
                const existingProduct = cart.find(item => item.ref === ref);
                const currentQuantityInCart = existingProduct ? existingProduct.quantity : 0;
                if (currentQuantityInCart + quantity > stock) {
                    alert(`No puedes a√±adir m√°s unidades. Stock disponible: ${stock}`);
                    return;
                }
                if (existingProduct) {
                    existingProduct.quantity += quantity;
                } else {
                    cart.push({ ref: ref, quantity: quantity, product: product });
                }
                updateCart();
                const card = document.querySelector(`[data-ref="${ref}"]`);
                if(card) {
                    card.replaceWith(createProductCard(allProducts.find(p => p['Referencia Interna'] === ref)));
                }
                if (quantity === 1) {
                    showNotification('cart-notification');
                    if (buttonElement) {
                        const icon = buttonElement.querySelector('i');
                        buttonElement.classList.add('bg-green-500'); icon.classList.replace('fa-plus', 'fa-check');
                        setTimeout(() => {
                            buttonElement.classList.remove('bg-green-500'); icon.classList.replace('fa-check', 'fa-plus');
                        }, 1000);
                    }
                }
            }
            function handleAddToCartPress(button) {
                longPressTimer = setTimeout(() => {
                    const ref = button.dataset.ref;
                    const productName = allProducts.find(p => p['Referencia Interna'] === ref)?.Nombre || ref;
                    const quantityStr = prompt(`¬øCu√°ntas unidades de "${productName}" quieres a√±adir?`, 1);
                    const quantity = parseInt(quantityStr, 10);
                    if (!isNaN(quantity) && quantity > 0) {
                        addToCart(ref, button, quantity);
                        showNotification('cart-notification');
                    }
                }, LONG_PRESS_DURATION);
            }
            function handleAddToCartRelease() { clearTimeout(longPressTimer); }
            function changeQuantity(ref, change) {
                const itemInCart = cart.find(item => item.ref === ref);
                if (!itemInCart) return;
                if (change > 0) {
                    const product = allProducts.find(p => p['Referencia Interna'] === ref);
                    const stock = product ? product.Stock || 0 : 0;
                    if (itemInCart.quantity + change > stock) {
                        alert(`No puedes a√±adir m√°s unidades. Stock disponible: ${stock}`);
                        return;
                    }
                }
                itemInCart.quantity += change;
                if (itemInCart.quantity <= 0) {
                    cart = cart.filter(item => item.ref !== ref);
                }
                updateCart();
            }
            function updateCart() {
                renderCart();
                cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
                cartTotal.textContent = `$${cart.reduce((sum, item) => sum + ((parseFloat(item.product.Precio) || 0) * item.quantity), 0).toFixed(2)}`;
            }
            function renderCart() {
                document.getElementById('quotation-date').textContent = new Date().toLocaleDateString('es-EC', { year: 'numeric', month: 'long', day: 'numeric' });
                if (cart.length === 0) {
                    cartItemsContainer.innerHTML = `<div class="text-center py-16"><i class="fas fa-shopping-cart text-gray-300 text-6xl mb-4"></i><p class="text-gray-500 text-lg font-medium">Tu cotizaci√≥n est√° vac√≠a</p><p class="text-gray-400 text-sm mt-2">A√±ade productos para comenzar</p></div>`;
                    return;
                }
                cartItemsContainer.innerHTML = cart.map(item => {
                    const imagePath = `images/${item.ref}.webp`;
                    const price = parseFloat(item.product.Precio) || 0;
                    const subtotal = price * item.quantity;
                    return `<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 flex items-start gap-4"><img src="${imagePath}" alt="${item.product.Nombre}" class="w-20 h-20 sm:w-24 sm:h-24 object-cover rounded-md bg-gray-100 flex-shrink-0 zoomable-image cursor-zoom-in" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';"><div class="flex-grow flex flex-col justify-between h-full"><div><h3 class="font-bold text-gray-800 leading-tight">${item.product.Nombre}</h3><p class="text-xs text-gray-500 mt-1">Ref: ${item.ref}</p><p class="sm:hidden text-sm font-semibold text-red-600 mt-1">$${price.toFixed(2)} c/u</p></div><div class="flex items-center gap-2 mt-2"><button class="change-quantity-button bg-gray-200 hover:bg-red-600 text-gray-700 hover:text-white w-7 h-7 rounded-full font-bold flex items-center justify-center transition-all" data-ref="${item.ref}" data-change="-1"><i class="fas fa-minus text-xs"></i></button><span class="font-bold text-md w-8 text-center">${item.quantity}</span><button class="change-quantity-button bg-gray-200 hover:bg-green-600 text-gray-700 hover:text-white w-7 h-7 rounded-full font-bold flex items-center justify-center transition-all" data-ref="${item.ref}" data-change="1"><i class="fas fa-plus text-xs"></i></button></div></div><div class="flex flex-col items-end justify-between h-full text-right flex-shrink-0"><p class="hidden sm:block text-sm text-gray-500">$${price.toFixed(2)} c/u</p><p class="font-bold text-lg text-gray-800 mt-auto">$${subtotal.toFixed(2)}</p></div></div>`;
                }).join('');
            }
            function closeCartModal() {
                cartModalOverlay.classList.remove('flex');
                renderProducts();
            }
            function shareOnWhatsApp() {
                if (cart.length === 0) { alert("No hay productos en el carrito para compartir."); return; }
                const clientName = clientNameInput.value.trim();
                const fecha = new Date().toLocaleDateString('es-EC');
                let message = `üìã *COTIZACI√ìN - AROMOTOR* üìã\n\n`;
                if (clientName) message += `*Cliente:* ${clientName}\n`;
                message += `*Fecha:* ${fecha}\n--------------------------------------\n\n*Detalle del Pedido:*\n\n`;
                cart.forEach(item => {
                    const price = parseFloat(item.product.Precio) || 0;
                    const subtotal = price * item.quantity;
                    message += `üì¶ *${item.product.Nombre}*\n   ‚Ä¢ *Ref:* ${item.ref}\n   ‚Ä¢ *Cant:* ${item.quantity}\n   ‚Ä¢ *Precio:* $${price.toFixed(2)}\n   ‚Ä¢ *Subtotal:* *$${subtotal.toFixed(2)}*\n\n`;
                });
                message += `--------------------------------------\nTOTAL DEL PEDIDO: *${cartTotal.textContent}*\n\n_Gracias por su preferencia._`;
                const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            }
            function saveCurrentCart() {
                const clientName = clientNameInput.value.trim();
                if (cart.length === 0 || !clientName) { alert("Por favor, ingresa un nombre de cliente y a√±ade productos para guardar."); return; }
                const newOrder = { id: Date.now(), clientName: clientName, items: JSON.parse(JSON.stringify(cart)), total: cart.reduce((sum, item) => sum + ((parseFloat(item.product.Precio) || 0) * item.quantity), 0), synced: navigator.onLine };
                savedCarts.push(newOrder);
                localStorage.setItem('savedCarts', JSON.stringify(savedCarts));
                clientNameInput.value = ''; closeCartModal(); showNotification('saved-notification');
            }
            function renderSavedCarts() {
                if (savedCarts.length === 0) { savedOrdersContainer.innerHTML = '<p class="text-gray-500">No hay pedidos guardados.</p>'; return; }
                savedOrdersContainer.innerHTML = savedCarts.map(saved => `<div class="flex items-center justify-between border-b py-3 gap-2"><div class="flex-grow min-w-0"><div class="flex items-center gap-2">${!saved.synced ? '<i class="fas fa-exclamation-triangle text-yellow-500" title="Guardado sin conexi√≥n"></i>' : ''}<p class="font-bold truncate">${saved.clientName}</p></div><p class="text-sm text-gray-500">${saved.items.length} tipo(s) de producto</p><p class="text-sm font-semibold text-red-600">$${saved.total.toFixed(2)}</p></div><div class="flex gap-2"><button class="load-cart-button bg-green-500 text-white py-1 px-3 rounded hover:bg-green-600" data-id="${saved.id}">Cargar</button><button class="delete-cart-button bg-red-600 text-white py-1 px-3 rounded hover:bg-red-700" data-id="${saved.id}">Borrar</button></div></div>`).join('');
            }
            function loadSavedCart(id) {
                const saved = savedCarts.find(s => s.id == id);
                if (saved) {
                    cart = JSON.parse(JSON.stringify(saved.items));
                    clientNameInput.value = saved.clientName;
                    updateCart(); savedOrdersModalOverlay.classList.remove('flex'); cartModalOverlay.classList.add('flex');
                }
            }
            function deleteSavedCart(id) {
                if (confirm("¬øEst√°s seguro de que quieres borrar este pedido guardado?")) {
                    savedCarts = savedCarts.filter(s => s.id != id);
                    localStorage.setItem('savedCarts', JSON.stringify(savedCarts));
                    renderSavedCarts();
                }
            }
            function showNotification(id) {
                const n = document.getElementById(id);
                n.classList.add('opacity-100', 'translate-y-0'); n.classList.remove('opacity-0', 'translate-y-2');
                setTimeout(() => { n.classList.remove('opacity-100', 'translate-y-0'); n.classList.add('opacity-0', 'translate-y-2'); }, 2000);
            }

            // --- CAMBIO: Event Listeners actualizados para la nueva l√≥gica de filtros ---
            searchBox.addEventListener('input', renderProducts);
            categoryFilter.addEventListener('change', updateFiltersAndRender);
            subcategoryFilter.addEventListener('change', updateFiltersAndRender);
            typeFilter.addEventListener('change', renderProducts);
            clearFiltersBtn.addEventListener('click', () => { 
                searchBox.value = ''; 
                categoryFilter.value = ''; 
                subcategoryFilter.value = '';
                typeFilter.value = '';
                // Al limpiar, repoblamos los filtros a su estado inicial y renderizamos
                populateFilters();
                renderProducts();
            });
            
            // (El resto de listeners permanecen igual)
            cartButton.addEventListener('click', () => cartModalOverlay.classList.add('flex'));
            closeCartModalButton.addEventListener('click', closeCartModal);
            cartModalOverlay.addEventListener('click', (e) => { if (e.target === cartModalOverlay) closeCartModal(); });
            clearCartButton.addEventListener('click', () => { cart = []; updateCart(); });
            cartItemsContainer.addEventListener('click', e => {
                const zoomTrigger = e.target.closest('.zoomable-image'); if (zoomTrigger) { zoomedImage.src = zoomTrigger.src; imageZoomModalOverlay.classList.add('flex'); }
                const quantityBtn = e.target.closest('.change-quantity-button'); if(quantityBtn) { changeQuantity(quantityBtn.dataset.ref, parseInt(quantityBtn.dataset.change, 10)); }
            });
            productGrid.addEventListener('click', e => {
                const copyBtn = e.target.closest('.copy-button'); if (copyBtn) { navigator.clipboard.writeText(copyBtn.dataset.info).then(() => showNotification('copy-notification')); return; }
                const cartBtn = e.target.closest('.add-to-cart-button'); if (cartBtn) { addToCart(cartBtn.dataset.ref, cartBtn, 1); }
                const zoomTrigger = e.target.closest('.zoomable-image'); if (zoomTrigger) { zoomedImage.src = zoomTrigger.src; imageZoomModalOverlay.classList.add('flex'); }
            });
            productGrid.addEventListener('mousedown', e => { const cartBtn = e.target.closest('.add-to-cart-button'); if (cartBtn) handleAddToCartPress(cartBtn); });
            productGrid.addEventListener('mouseup', e => { const cartBtn = e.target.closest('.add-to-cart-button'); if (cartBtn) handleAddToCartRelease(); });
            productGrid.addEventListener('mouseleave', e => { const cartBtn = e.target.closest('.add-to-cart-button'); if (cartBtn) handleAddToCartRelease(); }, true);
            productGrid.addEventListener('touchstart', e => { const cartBtn = e.target.closest('.add-to-cart-button'); if (cartBtn) handleAddToCartPress(cartBtn); });
            productGrid.addEventListener('touchend', e => { const cartBtn = e.target.closest('.add-to-cart-button'); if (cartBtn) handleAddToCartRelease(); });
            shareWhatsappButton.addEventListener('click', shareOnWhatsApp);
            saveCartButton.addEventListener('click', saveCurrentCart);
            savedOrdersButton.addEventListener('click', () => { renderSavedCarts(); savedOrdersModalOverlay.classList.add('flex'); });
            closeSavedOrdersModalButton.addEventListener('click', () => savedOrdersModalOverlay.classList.remove('flex'));
            savedOrdersContainer.addEventListener('click', e => {
                if (e.target.closest('.load-cart-button')) loadSavedCart(e.target.closest('.load-cart-button').dataset.id);
                if (e.target.closest('.delete-cart-button')) deleteSavedCart(e.target.closest('.delete-cart-button').dataset.id);
            });
            viewToggle.addEventListener('click', e => {
                const btn = e.target.closest('.view-btn');
                if (btn && !btn.classList.contains('text-red-600')) {
                    currentView = btn.dataset.view;
                    document.querySelectorAll('.view-btn').forEach(b => { b.classList.remove('text-red-600'); b.classList.add('text-gray-400'); });
                    btn.classList.add('text-red-600'); btn.classList.remove('text-gray-400');
                    renderProducts();
                }
            });
            const closeZoomModal = () => { imageZoomModalOverlay.classList.remove('flex'); zoomedImage.src = ""; };
            closeZoomModalButton.addEventListener('click', closeZoomModal);
            imageZoomModalOverlay.addEventListener('click', (e) => { if (e.target === imageZoomModalOverlay) closeZoomModal(); });

            loadProducts();
        });
    </script>
</body>
</html>
